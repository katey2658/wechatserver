<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>电商数据库设计及架构优化</title>
  </head>
  <body>
    <h4>涉及电商常用功能模块的数据库设计</h4>
    <p>
      注册会员->展示商品
      【用户模块】【商品模块】【物流模块】
    </p>
    <h4>项目说明</h4>
    <p>
      用户登录->选购商品->加购物车->检查库存->提交订单->货到付款->N->发货
    </p>
    <h3>项目说明</h3>
    <ul>
      <li>
        用户模块（完成用户注册和  登录验证)
      </li>
      <li>
        商品模块（前后台商品管理和浏览)
      </li>
      <li>
        订单模块(订单及购物车的生成和管理)
      </li>
      <li>
        仓配模块(仓库库存和物流的管理)
      </li>
    </ul>
    <h3>数据库设计规范</h3>
    <ul>
      <li>数据结构设计：逻辑设计->物理设计</li>
      <li>实际工作中:逻辑设计+物理设计</li>
      <li>物理设计：表名+字段名+字段类型</li>
    </ul>
    <ol>
      <li>数据库命名规范</li>
      <li>数据库基本设计规范</li>
      <li>数据库索引设计规范</li>
      <li>数据库字段设计规范(列的字段类型)</li>
      <li>数据库sql开发规范</li>
      <li>数据库操作行为规范</li>
    </ol>

    <h4>数据库命名规范</h4>
    <ul>
      <li>所有数据库对象名称必须使用小写字母并用下划线分割(mysql默认情况下是大小写敏感的，在linux下表是文件)</li>
      <li>所有数据库对象名称禁止使用MySQL保留关键字：如果使用了关键字作为字段，可以使用反向的单引号括起来</li>
      <li>数据库对象的命名要能做到见名知意，并且最好不要超过32个字符</li>
      <li>所有临时库表必须以tmp_为前缀（备份库，备份表必须以bak_为前缀）并以时间戳为后缀</li>
      <li>所有存储相同数据的列名和列类型必须一致</li>
    </ul>


    <h4>数据库基本设计规范</h4>
    <ul>
      <li>所有表必须使用Innodb存储引擎(5.6之后默认)，支持事务，行级锁，更好的恢复性，高并发下性能更好：
        Mysql5.5使用之前Myisam(默认存储引擎)情况
      </li>
      <li>数据库和表字符集统一使用UTF-8：
        兼容性好，避免由于字符集转换产生的乱码,mysql中utf-8字符集汉字占3个字节，ASCLL占1个字节</li>
      <li>所有表和字段都需要添加注释 comment从句添加表和列的备注
          从一开始就进行数据字典的维护
      </li>
      <li>尽量控制单表数据量的大小，建议控制在500万(并不是限制，限制取决于存储设置和文件系统)以内
        ：太大修改表结构，备份，恢复都会有很大问题；
      可以用历史数据归档，分库分表等手段来控制数据量大小
      </li>
      <li>谨慎使用Mysql分区表：
        分区 表在物理上为多个文件，在逻辑上表现为一个表，磁盘IO更好利用；
        谨慎选择分区键，跨分区查询效率可能更低；
        建议采用物理分表的方式管理大数据
      </li>
      <li>尽量做到冷热数据分离，减小表的宽度：
         Mysql限制最多存储4096列，每个不能超过65535字节；
         减少磁盘IO,保证热数据的内存缓存命中率
         利用更有效的利用缓存，避免读入无用的冷数据
         经常一起使用列放在一个表</li>
      <li>禁止在表中预留字段：
          预留字段的命名很难做到见名示意；
          预留字段无法确认存储的数据类型，所以无法选择合适的类型；
          对预留字段类型的修改，会对表进行锁定：现阶段，修改一个字段成本高于添加一个字段成本
      </li>
      <li>禁止在数据库中存储图片，文件等二进制数据:过多使用blob等会影响数据库性能，将图片文件放到文件服务器中</li>
      <li>禁止在线上做数据库压力测试</li>
      <li>禁止从开发环境，测试环境直接连生产环境数据库</li>
    </ul>

    <h4>索引设计规范</h4>
    <ul>
      <li>限制每张表上的索引数量，建议单张表索引不超过5个：
      索引可以增加查询效率，但同样会降低插入和更新的效率；
      禁止给表中的每一列都建立单独的索引(5.6以前，一个，后可以合并索引)</li>
      <li>每个Innodb表必须有一个主键：
          不使用更新频繁的列作为主键，不使用多列(联合)主键，Innodb是索引组织表；
          不使用UUID,MD5，HASH,字符串作为主键；
          主键建议选择使用自增ID值
        </li>
      <li>
        <h5>常见索引列建议</h5>
        <ul>
          <li>select,update,delete语句的where从句中的列 </li>
          <li>包含在order by,group by,distinct中的语句</li>
          <li>多表join的关联列</li>

          <li>索引类顺序从左到右</li>
          <li>区分度最高的列放在联合索引的最左侧</li>
          <li>尽量把字段长度小得列放在联合索引的最左侧</li>
          <li>使用最频繁的列放到联合索引的左侧</li>
          <li>避免建立冗余索引和重复索引</li>
          <li>对于频繁的查询优先考虑使用覆盖索引(包含了所有查询字段的索引)：
              避免Innodb表进行索引的二次查找；
              可以把随机IO变成顺序IO，加快查询效率
          </li>
          <li>尽量避免使用外键：mysql会自动索引；
              不建议使用外键约束，但一定在表和表之间的关联键上建立索引；
            外键可用于保证数据的参照完整性，但建议在业务端实现</li>
        </ul>
      </li>
    </ul>

    <h4>数据库字段设计规范</h4>
    <ul>
      <li>优先选择符合存储需要的最小的数据类型：
           将字符串转化为数字类型存储(inet_about('255.255.255.255'),inet_ntoa(37388678))
      </li>
      <li>对于非负型的数据来说，要优先使用无符号整型来存储：
        无符号相对于有符号可以多出一倍的存储空间；
        varchar(N)中的N代表的是字符数，不是字节数，utf8存储varchar(255)需要765个字节
        过大的长度会消耗更多的内存
      </li>
      <li>尽量避免使用text,blob数据类型:会二次查询，性能很差；
          建议把blob 或text列分离到单独的扩展表中;
          只能使用前置索引</li>
      <li>避免使用enum数据库类型(其它数据库没有)：
          存储是整数；
          修改Enum值需要使用Alter语句；
         enum整数的order by操作效率低，需要额外操作；
         禁止使用数值作为enum的枚举值
       </li>
       <li>尽可能把所有列定义为not null:
           索引null列需要额外的空间来保存，所以要占用更多的空间；
           进行比较和计算时对null值做特别的处理</li>
       <li>使用timestamp（1970-01-01 00：00：01~2038-01-19 03：14：07，占用4字节和int相同，但比int可读性高）或datetime类型存储时间：
           避免用字符串存储日期型的数据；
           无法用日期函数进行计算和比较；
           用字符串存储日期占用更多空间；
       </li>
       <li>同财务有关的金额类数据，必须使用decimal：
          decimal 类型为精准浮点，在计算时不会丢失精度;
          占用空间由定义的宽度决定，小数点占一个字节；
          可用于存储比bigint更大的整数数据</li>
    </ul>

    <h4>数据库sql开发规范</h4>
    <ul>
      <li>建议使用预编译语句进行数据库操作：
          只传参数，比传递sql更高效；
          相同语句可以一次解析，多次复用，防止sql注入</li>
      <li>避免数据类型的隐式转换：
          隐式转换会导致索引失效</li>
      <li>合理利用存在索引，而不是盲目添加索引</li>
      <li>充分利用表上已经存在的索引：
          避免使用带双%号的查询条件；
          一个sql只能利用到复合索引中的一列进行范围查找；
          使用left on 或not exits 而不是not in(索引可能会失效)</li>
      <li>程序连接不同的数据库使用不同的账号，禁止跨库查询：
        为数据库迁移和分库分表留出余地；
       降低业务耦合度；
       避免权限过大而产生的安全风险
      </li>
      <li>禁止使用select * 必须明确指明字段列表：
          消耗过更多的cpu和io以及网络带宽资源；
          无法使用覆盖索引；
          减少表结构变更带来的影响</li>
      <li>禁止使用不含字段列表的insert语句</li>
      <li>避免使用子查询，可以把子查询优化为join操作：
          子查询的结果集无法使用索引；
          子查询会产生临时表操作，如果子查询数据量大则严重影响效率；
           消耗过多的cpu及io资源（导致慢查询);
          </li>
      <li>避免使用join关联太多的表：
          每join一个表多占用一部分内存(join_buffer_size,缓存);
          会产生临时表操作，影响查询效率；
          mysql最多允许关联62个表，建议不超过5个
      </li>
      <li>减少同数据库的交互次数：
          数据库更适合处理批量操作；
          合并多个相同的操作到一起，可以提高处理效率
      </li>
      <li>使用in 代替or:
          in的值不要操作500；
          in操作可以有效的利用索引
      </li>
      <li>禁止使用order by rand()进行随机排序：
          会把表中所符合条件的数据装载有内存中进行排序；
          消耗大量的cpu和io及内存资源；
          推荐在程序中获取一个随机值，然后从数据库中获取数据的方式</li>
      <li>where从句中禁止对列进行函数转换和计算：
          对列进行函数转换或计算会导致无法使用索引</li>
      <li>在明显不会有重复值时使用union all而不是union：
          union会把所有数据放到临时表中再进行去重操作；
          union all不会对结果集进行去重操作</li>
      <li>拆分复杂的大sql为多个小sql:
          mysql一个sql只能使用一个cpu进行查询；
          sql拆分后可以通过并行执行来执行提高处理效率</li>
    </ul>

    <h4>数据库操作行为规范</h4>
    <ul>
      <li>超过100万的批量写操作，要分批多次进行操作：
          大批量操作可能会造成严重的主从延迟；
          binlog日志为row格式时会产生大量的日志；
          避免产生大事务操作
      </li>
      <li>对于大表使用pt-online-scheme-change修改表结构：
          避免大表修改产生的主从延迟；
          避免在对表字段进行修改时进行锁表
      </li>
      <li>禁止为程序使用的账号赋予super权限：
          当达到最大连接数限制时，还允许1个有super权限的用户连接</li>
      <li>super权限只能留给dba处理问题的账号使用</li>
      <li>对于程序连接数据库账号，遵循权限最小原则：
          程序使用的数据库账号，只能在一个db下使用，不准跨库；
          程序使用的账号原则上不准有drop权限</li>
    </ul>
  </body>
</html>
